<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standalone BTC Miner Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="manifest" href="/manifest.json">

    <style>
        /* Custom monospace font fallback for the logo */
        .font-code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
        /* Hide scrollbar for console, but keep scrolling */
        .console-output::-webkit-scrollbar { display: none; }
        .console-output { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Subtle animation for the status box */
        @keyframes pulse-border {
            0%, 100% { border-color: #1f6feb; }
            50% { border-color: #3b82f6; }
        }
        .status-pulse {
            animation: pulse-border 4s infinite ease-in-out;
        }

        /* Styles for the selected package button */
        .package-button.selected {
            background-color: #26a69a; /* usdt-green */
            color: #0d1117; /* miner-dark text */
            box-shadow: 0 4px 14px 0 rgba(38, 166, 154, 0.5);
            border-color: #26a69a;
        }
        
        /* Custom file input style for better mobile touch */
        .custom-file-input {
            cursor: pointer;
            padding: 1rem;
            border-radius: 0.5rem;
            background-color: #1f2937;
            border: 1px solid #4b5563;
            text-align: center;
        }
        .custom-file-input:hover {
            background-color: #374151;
        }

    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'miner-dark': '#0d1117',
                        'miner-console': '#161b22',
                        'miner-status-border': '#1f6feb',
                        'miner-balance': '#00bcd4',
                        'miner-price': '#ffc107', /* Used for BTC Gold color */
                        'miner-info': '#38a169',
                        'miner-warning': '#dc3545',
                        'lock-bg': '#1e2530',
                        'usdt-green': '#26a69a', /* USDT color */
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-miner-dark text-white p-6 min-h-screen flex flex-col items-center">

    <div id="lockScreen" class="w-full max-w-md flex flex-col items-center justify-center min-h-screen absolute top-0 left-0 bg-miner-dark z-50 p-6">
        
        <h1 class="text-2xl font-bold text-white mb-8 text-center">Welcome to Mining x crypto miner</h1>

        <div class="font-code text-miner-price text-3xl mb-8 leading-none text-center">
            <pre>LICENSE REQUIRED</pre>
        </div>
        <div class="bg-lock-bg p-8 rounded-lg shadow-2xl w-full border border-miner-status-border">
            <h3 class="text-xl font-bold mb-4 text-center">Enter License Key</h3>
            
            <div id="lockMessage" class="text-center text-sm mb-4 text-miner-warning hidden"></div>

            <div class="mb-4">
                <input type="text" id="licenseKeyInput" placeholder="20-character key" class="w-full p-3 rounded bg-gray-700 border border-gray-600 text-white font-code tracking-wider focus:ring-miner-status-border focus:border-miner-status-border uppercase" maxlength="20">
            </div>
            
            <button id="enterKeyBtn" class="w-full bg-miner-status-border text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition duration-150 mb-4">
                Activate and Enter
            </button>
            
            <button id="buyNowBtn" class="w-full bg-usdt-green text-white py-3 rounded-lg font-bold hover:bg-teal-600 transition duration-150 mb-4">
                View Pricing & Buy License
            </button>

            <div class="text-center mt-3 flex justify-center space-x-4">
                <a href="https://t.me/MiningXowner" target="_blank" class="text-sm text-blue-400 hover:text-blue-300 underline lowercase font-semibold">telegram support</a>
                <a href="#" id="referralLink" class="text-sm text-miner-price hover:text-yellow-300 underline lowercase font-semibold">referral program</a>
            </div>

            <div class="mt-4 text-center">
                <p class="text-lg text-miner-price font-bold">
                    Packages from $140 to $400.
                </p>
                <p class="text-xs text-gray-500 italic mt-1">
                    See payment page for details.
                </p>
            </div>
        </div>
    </div>
    
    <div id="paymentPage" class="w-full max-w-md hidden min-h-screen pt-12 pb-12">
        <button id="backFromPaymentBtn" class="mb-6 text-miner-status-border hover:text-blue-400 flex items-center transition duration-150">
            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            <span class="text-sm font-semibold">Back to Login</span>
        </button>
        
        <div class="bg-miner-console p-6 rounded-xl shadow-2xl border-t-4 border-usdt-green">
            <h2 class="text-3xl font-extrabold text-center mb-6 text-usdt-green uppercase tracking-wider">
                Select License Package
            </h2>
            
            <div class="flex justify-center space-x-2 mb-6">
                <button id="package1Month" 
                        data-package="1_month" data-price="140" data-days="30"
                        class="package-button flex-1 py-3 px-2 rounded-lg font-bold border border-gray-600 text-gray-300 bg-gray-700 hover:bg-gray-600 transition duration-150">
                    1 Month ($140)
                </button>
                <button id="package6Month"
                        data-package="6_month" data-price="260" data-days="180"
                        class="package-button flex-1 py-3 px-2 rounded-lg font-bold border border-gray-600 text-gray-300 bg-gray-700 hover:bg-gray-600 transition duration-150">
                    6 Months ($260)
                </button>
                <button id="package1Year" 
                        data-package="1_year" data-price="400" data-days="365"
                        class="package-button flex-1 py-3 px-2 rounded-lg font-bold border border-gray-600 text-gray-300 bg-gray-700 hover:bg-gray-600 transition duration-150">
                    1 Year ($400)
                </button>
            </div>
            
            <div id="packageDetails" class="bg-gray-800 p-4 rounded-lg mb-6 text-center text-sm">
                <p id="selectedPackageDisplay" class="font-bold text-lg text-miner-price mb-1">Select a package above.</p>
                <p class="text-gray-400">Duration: <span id="durationDisplay">N/A</span> days</p>
            </div>

            <div class="mb-6">
                <p class="text-gray-400 text-sm mb-2">Deposit Address (USDT TRC20)</p>
                <div class="bg-gray-700 p-3 rounded-lg flex justify-between items-center">
                    <span id="receivingWalletAddress" class="font-code text-usdt-green text-sm truncate">Loading...</span>
                    <button id="copyAddressBtn" class="ml-3 text-miner-price hover:text-yellow-300 focus:outline-none transition duration-150" title="Copy Address">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2m-2-4l-4 4m0 0l4 4m0-4h-8"></path></svg>
                    </button>
                </div>
            </div>

            <div class="mb-6">
                <label for="payerEmailInput" class="block text-gray-400 text-sm font-bold mb-2">Your Email (for key activation)</label>
                <input type="email" id="payerEmailInput" placeholder="your@email.com" class="w-full p-3 rounded bg-gray-700 border border-gray-600 text-white focus:ring-usdt-green focus:border-usdt-green">
            </div>

            <div class="mb-6">
                <label for="transactionScreenshot" class="block text-gray-400 text-sm font-bold mb-2">Transaction Screenshot (Proof of Payment)</label>
                <input type="file" id="transactionScreenshot" accept="image/*" class="hidden">
                <label for="transactionScreenshot" id="screenshotLabel" class="custom-file-input block text-gray-400 hover:text-white transition"> Tap to Upload Image </label>
                <p id="fileNameDisplay" class="text-xs text-gray-500 mt-2 italic text-center">No file selected.</p>
            </div>

            <button id="paymentMadeBtn" class="w-full bg-usdt-green text-gray-900 py-3 rounded-lg font-bold hover:bg-teal-400 transition duration-150 shadow-lg uppercase tracking-wider">
                Payment Has Been Made - Submit Request
            </button>
            
            <p id="paymentConfirmationMessage" class="mt-4 text-center text-miner-info hidden">
                Your payment intent has been logged. Please wait for email confirmation.
            </p>
            <p id="paymentError" class="mt-4 text-center text-miner-warning hidden">
                An error occurred during submission.
            </p>
            
            <p class="text-xs text-gray-500 text-center mt-4">
                Min. withdrawal: $<span id="minUsdWithdrawalDisplay">Loading...</span>. Fee: <span id="networkFeeDisplay">Loading...</span> BTC.
            </p>
        </div>
    </div>

    <div id="mainContent" class="w-full max-w-md hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold font-code text-miner-status-border">Mining x</h1>
            <div id="statusIndicator" class="text-miner-info font-bold flex items-center">
                <span class="relative flex h-3 w-3 mr-2">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-miner-info opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-miner-info"></span>
                </span>
                ACTIVE
            </div>
        </div>

        <div class="bg-miner-console border border-miner-status-border p-4 mb-5 rounded-lg shadow-lg status-pulse">
            <p class="text-miner-balance mb-1 font-code">Current Balance: <span id="balance">0.00000000</span> BTC</p>
            <p class="text-miner-price mb-1 font-code">Current BTC Price: $<span id="btc_price">0.00</span></p>
            <p class="text-miner-info font-code">USD Value: $<span id="usd_value">0.00</span></p>
            <p class="text-sm text-gray-500 mt-2">License Expires: <span id="expiration_date_display" class="font-code text-xs text-miner-warning">Checking...</span></p>
        </div>

        <div class="flex space-x-4 mb-5">
            <button id="withdrawBtn" class="flex-1 bg-usdt-green text-gray-900 py-3 rounded-lg font-bold hover:bg-teal-400 transition duration-150 uppercase tracking-wider">
                Withdraw
            </button>
            <button id="logoutBtn" class="bg-gray-600 text-white py-3 px-6 rounded-lg font-bold hover:bg-gray-500 transition duration-150">
                Logout
            </button>
        </div>

        <div id="withdrawalForm" class="bg-miner-console p-4 rounded-lg border border-gray-700 mb-5 hidden">
            <h3 class="text-xl font-bold mb-4 text-miner-price">Initiate Withdrawal</h3>
            <div class="mb-4">
                <label for="withdrawAmount" class="block text-gray-400 text-sm font-bold mb-2">Amount to Withdraw (BTC)</label>
                <input type="number" id="withdrawAmount" placeholder="0.00000000" class="w-full p-3 rounded bg-gray-700 border border-gray-600 text-white font-code focus:ring-usdt-green focus:border-usdt-green" step="0.00000001">
            </div>
            <button id="confirmWithdrawBtn" class="w-full bg-miner-status-border text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition duration-150 mb-3">
                Confirm Withdrawal
            </button>
            <p id="withdrawalStatus" class="text-center text-sm text-miner-warning"></p>
        </div>

        <h2 class="text-lg font-bold mb-3 text-miner-status-border font-code">Console Output:</h2>
        <div id="consoleOutput" class="console-output bg-miner-console p-3 h-48 overflow-y-scroll rounded-lg border border-gray-700 text-sm font-code">
            </div>
    </div>

    <div id="appModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-miner-console p-6 rounded-lg w-full max-w-sm border-t-4 border-miner-warning shadow-2xl">
            <h3 id="modalTitle" class="text-xl font-bold mb-3 text-miner-warning">Modal Title</h3>
            <p id="modalMessage" class="text-gray-300 mb-5">Modal message content.</p>
            <button id="modalCloseBtn" class="w-full bg-miner-status-border text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition duration-150">
                Close
            </button>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const STARTING_BALANCE = 0.00000000;
        const REMOTE_KEY_URL = '/.netlify/functions/license';
        const MINE_URL = '/.netlify/functions/mine';
        const PAYMENTS_URL = '/.netlify/functions/payments';
        const MAX_RETRIES = 3;
        const TELEGRAM_URL = 'https://t.me/MiningXowner';

        // --- NEW PRICE CONSTANTS ---
        const BINANCE_PRICE_URL = 'https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT';
        const PRICE_UPDATE_INTERVAL_MS = 300; // Update price every 300ms

        // --- Package Configuration (Client-side mirror of server) ---
        // Used to display price/duration on the payment page before submission
        const CLIENT_PACKAGES = {
            '1_month': { price: 140.00, days: 30, label: '1 Month' },
            '6_month': { price: 260.00, days: 180, label: '6 Months' },
            '1_year': { price: 400.00, days: 365, label: '1 Year' }
        };

        // --- Intervals and Keys ---
        let miningRate = 1000; // Default: 1 second per cycle
        let miningInterval = null;
        let btcPriceInterval = null; // NEW: Interval for real BTC price updates
        let activeLicenseKey = localStorage.getItem('minerCurrentLicenseKey');
        let currentPackageKey = '1_month'; // Default package
        
        // --- Local State Management Keys ---
        const ACTIVATED_LICENSES_KEY = 'minerActivatedLicenses';
        const CURRENT_LICENSE_ID_KEY = 'minerCurrentLicenseKey';
        const DEVICE_ID_KEY = 'minerDeviceID'; 

        // --- Application State ---
        let minerState = {
            balance: STARTING_BALANCE,
            btc_price: 0.00, // Will be set by fetchRealBtcPrice
            usd_value: 0.00,
            expiration_date: null,
            network_fee: 0.00010000,
            min_usd_withdrawal: 100.00,
            receiving_wallet_address: 'Loading...',
        };

        // --- DOM Elements ---
        const lockScreen = document.getElementById('lockScreen');
        const paymentPage = document.getElementById('paymentPage');
        const mainContent = document.getElementById('mainContent');
        const licenseKeyInput = document.getElementById('licenseKeyInput');
        const enterKeyBtn = document.getElementById('enterKeyBtn');
        const buyNowBtn = document.getElementById('buyNowBtn');
        const backFromPaymentBtn = document.getElementById('backFromPaymentBtn');
        const packageButtons = document.querySelectorAll('.package-button');
        const paymentMadeBtn = document.getElementById('paymentMadeBtn');
        const payerEmailInput = document.getElementById('payerEmailInput');
        const transactionScreenshotInput = document.getElementById('transactionScreenshot');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const paymentConfirmationMessage = document.getElementById('paymentConfirmationMessage');
        const paymentError = document.getElementById('paymentError');
        const consoleOutput = document.getElementById('consoleOutput');
        const balanceDisplay = document.getElementById('balance');
        const btcPriceDisplay = document.getElementById('btc_price');
        const usdValueDisplay = document.getElementById('usd_value');
        const expirationDateDisplay = document.getElementById('expiration_date_display');
        const receivingWalletAddressDisplay = document.getElementById('receivingWalletAddress');
        const networkFeeDisplay = document.getElementById('networkFeeDisplay');
        const minUsdWithdrawalDisplay = document.getElementById('minUsdWithdrawalDisplay');
        const withdrawBtn = document.getElementById('withdrawBtn');
        const withdrawalForm = document.getElementById('withdrawalForm');
        const confirmWithdrawBtn = document.getElementById('confirmWithdrawBtn');
        const withdrawAmountInput = document.getElementById('withdrawAmount');
        const withdrawalStatus = document.getElementById('withdrawalStatus');
        const modal = document.getElementById('appModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        const lockMessage = document.getElementById('lockMessage');
        const selectedPackageDisplay = document.getElementById('selectedPackageDisplay');
        const durationDisplay = document.getElementById('durationDisplay');
        const copyAddressBtn = document.getElementById('copyAddressBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const referralLink = document.getElementById('referralLink');


        // --- UTILITY FUNCTIONS ---
        
        function logToConsole(message, color) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const p = document.createElement('p');
            p.className = `text-xs mb-1 font-code`;
            p.style.color = color;
            p.innerHTML = `[${timeString}] ${message}`;
            consoleOutput.appendChild(p);
            // Auto-scroll to the bottom
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        function updateDisplay() {
            balanceDisplay.textContent = minerState.balance.toFixed(8);
            btcPriceDisplay.textContent = minerState.btc_price.toFixed(2);
            minerState.usd_value = minerState.balance * minerState.btc_price;
            usdValueDisplay.textContent = minerState.usd_value.toFixed(2);
            
            // Update license expiration display
            if (minerState.expiration_date) {
                const now = new Date();
                const exp = new Date(minerState.expiration_date);
                const diffTime = exp.getTime() - now.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays > 0) {
                    expirationDateDisplay.textContent = `${exp.toLocaleDateString()} (${diffDays} days left)`;
                    expirationDateDisplay.classList.remove('text-miner-warning');
                    expirationDateDisplay.classList.add('text-miner-info');
                } else {
                    expirationDateDisplay.textContent = 'EXPIRED. Please renew.';
                    expirationDateDisplay.classList.remove('text-miner-info');
                    expirationDateDisplay.classList.add('text-miner-warning');
                    stopMining();
                }
            } else {
                 expirationDateDisplay.textContent = 'N/A - Not Active';
            }
        }

        function saveMinerState() {
            const stateKey = getCurrentStateKey();
            if (stateKey) {
                localStorage.setItem(stateKey, JSON.stringify({
                    balance: minerState.balance,
                    btc_price: minerState.btc_price, // Save latest price (optional, but good practice)
                    expiration_date: minerState.expiration_date
                }));
            }
        }

        function getDeviceId() {
            let deviceId = localStorage.getItem(DEVICE_ID_KEY);
            if (!deviceId) {
                deviceId = crypto.randomUUID();
                localStorage.setItem(DEVICE_ID_KEY, deviceId);
            }
            return deviceId;
        }

        function updateView(viewId) {
            const views = [lockScreen, paymentPage, mainContent];
            views.forEach(view => {
                if (view.id === viewId) {
                    view.classList.remove('hidden');
                    if (view.id === 'lockScreen') {
                        view.classList.add('absolute', 'top-0', 'left-0');
                    } else {
                        view.classList.remove('absolute', 'top-0', 'left-0');
                    }
                } else {
                    view.classList.add('hidden');
                }
            });
            // Stop all activity when leaving the main content view
            if (viewId !== 'mainContent' && miningInterval !== null) {
                stopMining(); 
            }
        }

        function getCurrentStateKey() {
            if (!activeLicenseKey) return null;
            return `btcMinerState_${activeLicenseKey}`;
        }

        function loadMinerState() {
            const stateKey = getCurrentStateKey();
            if (!stateKey) {
                minerState.balance = STARTING_BALANCE;
                return;
            }
            try {
                const storedState = localStorage.getItem(stateKey);
                if (storedState) {
                    const state = JSON.parse(storedState);
                    minerState.balance = state.balance || STARTING_BALANCE;
                    minerState.expiration_date = state.expiration_date;
                } else {
                     minerState.balance = STARTING_BALANCE;
                }
            } catch (e) {
                console.error("Error loading state:", e);
                minerState.balance = STARTING_BALANCE;
            }
        }
        
        function selectPackage(packageKey) {
            currentPackageKey = packageKey;
            const details = CLIENT_PACKAGES[packageKey];
            
            packageButtons.forEach(btn => {
                if (btn.dataset.package === packageKey) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });

            selectedPackageDisplay.textContent = `${details.label} License ($${details.price.toFixed(2)})`;
            durationDisplay.textContent = details.days;
        }

        function showModal(title, message, isError = false) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            if (isError) {
                modalTitle.classList.remove('text-miner-info');
                modalTitle.classList.add('text-miner-warning');
                modal.querySelector('div').classList.remove('border-miner-status-border');
                modal.querySelector('div').classList.add('border-miner-warning');
            } else {
                modalTitle.classList.remove('text-miner-warning');
                modalTitle.classList.add('text-miner-info');
                modal.querySelector('div').classList.remove('border-miner-warning');
                modal.querySelector('div').classList.add('border-miner-status-border');
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }


        // --- NEW PRICE FETCHING LOGIC (USER REQUESTED CHANGE) ---

        /**
         * Fetches the real-time BTC price from the Binance API.
         * This function replaces the simulated price logic.
         */
        async function fetchRealBtcPrice() {
            try {
                const response = await fetch(BINANCE_PRICE_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const data = await response.json();
                const realPrice = parseFloat(data.price);
                
                if (!isNaN(realPrice) && realPrice > 0) {
                    // Update the state with the real price
                    minerState.btc_price = realPrice; 
                    updateDisplay();
                } else {
                    console.error('Fetched price is invalid:', data);
                }
            } catch (error) {
                // Log error but keep the last known price
                console.error('Error fetching real BTC price:', error); 
                // Fallback to initial price if current price is 0 (first run error)
                if (minerState.btc_price === 0) {
                    minerState.btc_price = 50000.00; // Use the old default simulation base price as a safety fallback
                    updateDisplay();
                }
            }
        }

        /**
         * Starts the real-time BTC price update interval (300ms).
         */
        function startPriceUpdater() {
            if (btcPriceInterval === null) {
                fetchRealBtcPrice(); // Run immediately to update price on load
                btcPriceInterval = setInterval(fetchRealBtcPrice, PRICE_UPDATE_INTERVAL_MS);
            }
        }

        /**
         * Stops the real-time BTC price update interval.
         */
        function stopPriceUpdater() {
            if (btcPriceInterval !== null) {
                clearInterval(btcPriceInterval);
                btcPriceInterval = null;
            }
        }

        // --- CORE APPLICATION LOGIC ---

        async function fetchConfig() {
            try {
                const response = await fetch(PAYMENTS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'fetch_config' })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    minerState.network_fee = parseFloat(data.NETWORK_FEE);
                    minerState.min_usd_withdrawal = parseFloat(data.MIN_USD_WITHDRAWAL);
                    minerState.receiving_wallet_address = data.RECEIVING_WALLET_ADDRESS;
                    
                    // Update payment page displays
                    networkFeeDisplay.textContent = minerState.network_fee.toFixed(8);
                    minUsdWithdrawalDisplay.textContent = minerState.min_usd_withdrawal.toFixed(2);
                    receivingWalletAddressDisplay.textContent = minerState.receiving_wallet_address;

                    // Update withdrawal form
                    const currentMax = withdrawAmountInput.max || 0;
                    if (minerState.balance > currentMax) {
                         withdrawAmountInput.max = minerState.balance;
                    }

                    return true;
                } else {
                    console.error('Failed to fetch config:', data.message);
                    return false;
                }
            } catch (error) {
                console.error('Config fetch error:', error);
                return false;
            }
        }
        
        async function processMiningCycle() {
            // Note: currentPrice is sent, but the server logic in mine.js still returns a newPrice.
            // However, we now IGNORE that newPrice on the client side, relying on the real-time
            // Binance feed via the btcPriceInterval.
            const payload = { 
                currentPrice: minerState.btc_price, // Still send current price
                packageKey: currentPackageKey 
            }; 

            try {
                const response = await fetch(MINE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (data.status === 'success') {
                    const amount = parseFloat(data.amountMined);
                    minerState.balance += amount;
                    
                    // --- IMPORTANT CHANGE: REMOVING SIMULATED PRICE UPDATE ---
                    // minerState.btc_price = parseFloat(data.newPrice); // REMOVED. Price is updated by fetchRealBtcPrice() every 300ms.
                    // --- END OF CHANGE ---

                    logToConsole(`Mined ${amount.toFixed(8)} BTC.`, '#ffc107'); // Log message simplified
                    updateDisplay();
                    saveMinerState();
                } else {
                    logToConsole(`Mining failed: ${data.message}`, '#dc3545');
                }
            } catch (error) {
                logToConsole(`Mining server error. Check connection.`, '#dc3545');
            }
        }

        function startMining() {
            if (miningInterval === null) {
                // Ensure price updates are running when mining starts
                startPriceUpdater(); 
                // Set mining interval
                miningInterval = setInterval(processMiningCycle, miningRate); 
                logToConsole('Mining cycle started.', '#38a169');
            }
        }
        
        function stopMining() {
            if (miningInterval !== null) {
                clearInterval(miningInterval);
                miningInterval = null;
            }
            // Stop real price updates when mining is stopped/logged out
            stopPriceUpdater(); 
            logToConsole('Mining cycle stopped.', '#dc3545');
        }

        function checkLicense() {
            activeLicenseKey = localStorage.getItem(CURRENT_LICENSE_ID_KEY);
            const licenses = JSON.parse(localStorage.getItem(ACTIVATED_LICENSES_KEY) || '{}');
            
            if (activeLicenseKey && licenses[activeLicenseKey]) {
                const licenseData = licenses[activeLicenseKey];
                const now = new Date();
                const expiry = new Date(licenseData.expiry);
                
                if (expiry > now) {
                    loadMinerState(); 
                    if (!minerState.expiration_date) {
                         minerState.expiration_date = licenseData.expiry;
                    }
                    currentPackageKey = licenseData.packageKey;
                    
                    logToConsole(`License for ${activeLicenseKey} is valid. Welcome back.`, '#38a169');
                    updateView('mainContent');
                    startMining();
                    return true;
                } else {
                    logToConsole('License expired. Re-activating is required.', '#dc3545');
                    localStorage.removeItem(CURRENT_LICENSE_ID_KEY);
                    delete licenses[activeLicenseKey];
                    localStorage.setItem(ACTIVATED_LICENSES_KEY, JSON.stringify(licenses));
                    activeLicenseKey = null;
                    return false;
                }
            }
            return false;
        }

        async function handleLicenseActivation(key) {
            enterKeyBtn.disabled = true;
            enterKeyBtn.textContent = 'Activating...';
            lockMessage.classList.add('hidden');
            const localDeviceID = getDeviceId();
            
            try {
                const response = await fetch(REMOTE_KEY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key: key.toUpperCase(), deviceID: localDeviceID })
                });
                const data = await response.json();
                
                if (data.valid) {
                    const licenses = JSON.parse(localStorage.getItem(ACTIVATED_LICENSES_KEY) || '{}');
                    
                    // Check if this key is known to be used on another device
                    if (licenses[key.toUpperCase()] && licenses[key.toUpperCase()].deviceId !== localDeviceID) {
                        lockMessage.textContent = "Error: This license key is already active on another device and cannot be reused.";
                        lockMessage.classList.remove('hidden');
                        enterKeyBtn.disabled = false;
                        enterKeyBtn.textContent = 'Activate and Enter';
                        return;
                    }

                    // For the simulator, we assign an expiry date based on the *current* package selection.
                    const packageDetails = CLIENT_PACKAGES[currentPackageKey];
                    const expiryDate = new Date();
                    expiryDate.setDate(expiryDate.getDate() + packageDetails.days);

                    // Update local storage for the successful key
                    const newLicenseData = { 
                        key: key.toUpperCase(), 
                        expiry: expiryDate.toISOString(), 
                        packageKey: currentPackageKey,
                        deviceId: localDeviceID
                    };
                    licenses[key.toUpperCase()] = newLicenseData;
                    localStorage.setItem(ACTIVATED_LICENSES_KEY, JSON.stringify(licenses));
                    localStorage.setItem(CURRENT_LICENSE_ID_KEY, key.toUpperCase());
                    activeLicenseKey = key.toUpperCase();
                    
                    minerState.expiration_date = expiryDate.toISOString();
                    minerState.balance = STARTING_BALANCE; // Reset balance on new activation
                    updateDisplay();

                    logToConsole(`License key ${key.toUpperCase()} successfully activated!`, '#38a169');
                    enterKeyBtn.textContent = 'Success!';
                    updateView('mainContent');
                    startMining();
                } else {
                    lockMessage.innerHTML = `License Key Check FAILED: <span class="text-miner-warning font-bold">Invalid License Key.</span><br>A new tab has opened. Please use it to contact <a href="${TELEGRAM_URL}" target="_blank" class="text-blue-400 hover:text-blue-300 underline lowercase font-semibold">telegram support</a> for assistance.`;
                    lockMessage.classList.remove('hidden');
                }
            } catch (error) {
                lockMessage.textContent = 'A connection error occurred during license validation. Please check your network.';
                lockMessage.classList.remove('hidden');
                console.error('License validation error:', error);
            } finally {
                enterKeyBtn.disabled = false;
                if(enterKeyBtn.textContent === 'Activating...') {
                     enterKeyBtn.textContent = 'Activate and Enter';
                }
            }
        }
        
        // --- EVENT LISTENERS ---

        // Lock Screen/Login
        enterKeyBtn.addEventListener('click', () => {
            const key = licenseKeyInput.value.trim().toUpperCase();
            if (key.length === 20) {
                handleLicenseActivation(key);
            } else {
                lockMessage.textContent = 'Please enter a valid 20-character license key.';
                lockMessage.classList.remove('hidden');
            }
        });

        buyNowBtn.addEventListener('click', () => {
             updateView('paymentPage');
             fetchConfig();
        });

        // Payment Page
        backFromPaymentBtn.addEventListener('click', () => {
            updateView('lockScreen');
        });
        
        modalCloseBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        });

        // Package Selection Listeners
        packageButtons.forEach(button => {
            button.addEventListener('click', () => {
                selectPackage(button.dataset.package);
            });
        });

        // File input listener
        transactionScreenshotInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                fileNameDisplay.textContent = file.name;
            } else {
                fileNameDisplay.textContent = 'No file selected.';
            }
        });

        // Copy Address Listener
        copyAddressBtn.addEventListener('click', () => {
             navigator.clipboard.writeText(receivingWalletAddressDisplay.textContent.trim());
             showModal('Copied!', 'The USDT TRC20 wallet address has been copied to your clipboard.', false);
        });
        
        // Convert file to base64 for server submission
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                // We only need the base64 part, not the mime type prefix (e.g., 'data:image/png;base64,')
                reader.onload = () => resolve(reader.result); 
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        async function handleSubmitPaymentIntent() {
            const email = payerEmailInput.value.trim();
            const screenshotFile = transactionScreenshotInput.files[0];
            paymentConfirmationMessage.classList.add('hidden');
            paymentError.classList.add('hidden');

            if (!email || !email.includes('@') || !email.includes('.')) {
                showModal('Invalid Email', 'Please enter a valid email address.', true);
                return;
            }
            if (!screenshotFile) {
                showModal('Missing Screenshot', 'Please upload a screenshot of your transaction proof.', true);
                return;
            }
            
            paymentMadeBtn.disabled = true;
            paymentMadeBtn.textContent = 'Submitting...';

            try {
                const screenshotDataUrl = await fileToBase64(screenshotFile);

                const response = await fetch(PAYMENTS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'submit_payment',
                        data: {
                            packageKey: currentPackageKey,
                            customerEmail: email,
                            screenshotData: screenshotDataUrl
                        }
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.status === 'success') {
                    paymentConfirmationMessage.classList.remove('hidden');
                } else {
                    paymentError.textContent = `Submission failed. Server message: ${data.message || 'Unknown error.'}`;
                    paymentError.classList.remove('hidden');
                }
            } catch (error) {
                paymentError.textContent = 'An internal error occurred during submission. Check console for details.';
                paymentError.classList.remove('hidden');
                console.error('Payment submission error:', error);
            } finally {
                paymentMadeBtn.disabled = false;
                paymentMadeBtn.textContent = 'Payment Has Been Made - Submit Request';
            }
        }

        paymentMadeBtn.addEventListener('click', handleSubmitPaymentIntent);
        
        // Main Content (Withdrawal/Logout)
        logoutBtn.addEventListener('click', () => {
             // For a cleaner logout, we only clear the current license key but keep the state (optional)
             localStorage.removeItem(CURRENT_LICENSE_ID_KEY); 
             activeLicenseKey = null;
             stopMining();
             updateView('lockScreen');
             licenseKeyInput.value = '';
             logToConsole('Logged out. Session ended.', '#dc3545');
        });
        
        withdrawBtn.addEventListener('click', () => {
            withdrawalStatus.textContent = ''; // Clear previous status
            withdrawalForm.classList.remove('hidden');
            withdrawBtn.classList.add('hidden');
            // Stop mining during withdrawal process
            stopMining(); 
            // Set max withdrawable amount
            withdrawAmountInput.value = minerState.balance.toFixed(8);
            withdrawAmountInput.max = minerState.balance; 
        });

        confirmWithdrawBtn.addEventListener('click', async () => {
            const amountToWithdraw = parseFloat(withdrawAmountInput.value);
            const currentBalance = minerState.balance;
            
            withdrawalStatus.textContent = 'Processing withdrawal...';
            withdrawalStatus.style.color = '#ffc107'; 

            if (isNaN(amountToWithdraw) || amountToWithdraw <= 0) {
                 withdrawalStatus.textContent = 'Please enter a valid amount.';
                 withdrawalStatus.style.color = '#dc3545';
                 return;
            }

            // Client-side validation
            if (amountToWithdraw > currentBalance) {
                showModal('Insufficient Balance', `Your request of ${amountToWithdraw.toFixed(8)} BTC exceeds the total available balance of ${currentBalance.toFixed(8)} BTC.`, true);
                return;
            }

            // Simulate server-side withdrawal call for validation
            try {
                const response = await fetch(PAYMENTS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'withdraw',
                        data: {
                            amount: amountToWithdraw,
                            currentBalance: currentBalance
                        }
                    })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    const received = parseFloat(data.received);
                    const fee = parseFloat(data.fee);

                    // Update client-side state after successful server-side check/action
                    logToConsole(`Withdrawal successful: ${received.toFixed(8)} BTC sent (Fee: ${fee.toFixed(8)}).`, '#38a169');
                    
                    // Reset balance in the state and display
                    minerState.balance = STARTING_BALANCE; 
                    updateDisplay(); 
                    saveMinerState();
                    
                    withdrawalStatus.textContent = `Withdrawal of ${received.toFixed(8)} BTC confirmed. Balance reset for this license key.`;
                    withdrawalStatus.style.color = '#38a169'; 

                    withdrawalForm.classList.add('hidden');
                    withdrawBtn.classList.remove('hidden');
                    // Restart mining after successful withdrawal
                    startMining(); 
                } else {
                    withdrawalStatus.textContent = data.message;
                    withdrawalStatus.style.color = '#dc3545';
                }

            } catch (error) {
                withdrawalStatus.textContent = 'Server error during withdrawal process.';
                withdrawalStatus.style.color = '#dc3545';
                console.error('Withdrawal error:', error);
            }
        });

        // Referral Link - Open Telegram on click
        referralLink.addEventListener('click', (e) => {
            e.preventDefault();
            // This is just a placeholder, the real referral logic would be server-side
            showModal('Referral Program', 'The referral program information will be provided via a secure link from telegram support.', false);
        });


        // --- Initialization on Load ---
        window.onload = () => {
            // Start the real-time BTC price updater immediately on load for all screens
            startPriceUpdater(); 
            fetchConfig(); // Fetch wallet address and fees

            // Check if a license is already active
            if (!checkLicense()) {
                updateDisplay(); 
            }
            // Set default package selection on payment page
            selectPackage(currentPackageKey);
        };
    </script>

</body>
</html>
